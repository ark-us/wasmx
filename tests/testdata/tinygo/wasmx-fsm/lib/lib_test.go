package lib

import (
	"encoding/json"
	"testing"

	wasmx "github.com/loredanacirstea/wasmx-env/lib"
	"github.com/stretchr/testify/require"
)

func TestCalldata(t *testing.T) {
	configBz := []byte(tendermintInit)
	var config MachineExternal
	err := json.Unmarshal(configBz, &config)
	require.NoError(t, err)
	require.Equal(t, "Tendermint-P2P-8", config.ID)
	require.Equal(t, wasmx.Bech32String("someaddr"), config.Library)
	require.Equal(t, 3, len(config.States))
	require.Equal(t, 3, len(config.States[1].States))
}

var tendermintInit = `{"id":"Tendermint-P2P-8","library":"someaddr","states":[{"name":"uninitialized","after":[],"always":[],"on":[{"name":"initialize","transitions":[{"target":"#Tendermint-P2P-8.initialized","guard":null,"actions":[],"meta":[]}]}],"entry":[],"exit":[],"initial":"","states":[]},{"name":"initialized","after":[],"always":[],"on":[],"entry":[],"exit":[],"initial":"unstarted","states":[{"name":"unstarted","after":[],"always":[],"on":[{"name":"setupNode","transitions":[{"target":"#Tendermint-P2P-8.initialized.unstarted","guard":null,"actions":[{"type":"setupNode","params":[]}],"meta":[]}]},{"name":"prestart","transitions":[{"target":"#Tendermint-P2P-8.initialized.prestart","guard":null,"actions":[],"meta":[]}]},{"name":"setup","transitions":[{"target":"#Tendermint-P2P-8.initialized.unstarted","guard":null,"actions":[{"type":"setup","params":[]}],"meta":[]}]},{"name":"start","transitions":[{"target":"#Tendermint-P2P-8.initialized.started","guard":null,"actions":[{"type":"connectPeers","params":[]},{"type":"connectRooms","params":[]},{"type":"requestBlockSync","params":[]}],"meta":[]}]}],"entry":[],"exit":[],"initial":"","states":[]},{"name":"prestart","after":[{"name":"500","transitions":[{"target":"#Tendermint-P2P-8.initialized.started","guard":null,"actions":[],"meta":[]}]}],"always":[],"on":[],"entry":[],"exit":[],"initial":"","states":[]},{"name":"started","after":[],"always":[],"on":[{"name":"newTransaction","transitions":[{"target":"","guard":{"type":"ifNewTransaction","params":[]},"actions":[{"type":"addToMempool","params":[]},{"type":"sendNewTransactionResponse","params":[]},{"type":"forwardMsgToChat","params":[{"key":"protocolId","value":"mempool"}]}],"meta":[]}]},{"name":"receiveStateSyncRequest","transitions":[{"target":"","guard":null,"actions":[{"type":"receiveStateSyncRequest","params":[]}],"meta":[]}]},{"name":"updateNode","transitions":[{"target":"","guard":null,"actions":[{"type":"updateNodeAndReturn","params":[]}],"meta":[]}]}],"entry":[],"exit":[],"initial":"Node","states":[{"name":"Node","after":[],"always":[{"name":"always","transitions":[{"target":"#Tendermint-P2P-8.initialized.started.Validator","actions":[{"type":"registerValidatorWithNetwork","params":[]}],"guard":{"type":"ifNodeIsValidator","params":[]},"meta":[]}]}],"on":[{"name":"becomeValidator","transitions":[{"target":"#Tendermint-P2P-8.initialized.started.Validator","guard":null,"actions":[{"type":"registerValidatorWithNetwork","params":[]},{"type":"requestBlockSync","params":[]}],"meta":[]}]},{"name":"receiveStateSyncResponse","transitions":[{"target":"","guard":null,"actions":[{"type":"receiveStateSyncResponse","params":[]}],"meta":[]}]},{"name":"start","transitions":[{"target":"","guard":null,"actions":[{"type":"connectPeers","params":[]},{"type":"connectRooms","params":[]},{"type":"requestBlockSync","params":[]}],"meta":[]}]},{"name":"receiveCommit","transitions":[{"target":"","guard":null,"actions":[{"type":"receiveCommit","params":[]}],"meta":[]}]},{"name":"receiveUpdateNodeResponse","transitions":[{"target":"","guard":null,"actions":[{"type":"receiveUpdateNodeResponse","params":[]}],"meta":[]}]}],"entry":[],"exit":[],"initial":"","states":[]},{"name":"Validator","after":[],"always":[],"on":[{"name":"receiveBlockProposal","transitions":[{"target":"","guard":{"type":"ifSenderIsProposer","params":[]},"actions":[{"type":"receiveBlockProposal","params":[]}],"meta":[]}]},{"name":"stop","transitions":[{"target":"#Tendermint-P2P-8.stopped","guard":null,"actions":[],"meta":[]}]},{"name":"receiveUpdateNodeResponse","transitions":[{"target":"","guard":null,"actions":[{"type":"receiveUpdateNodeResponse","params":[]}],"meta":[]}]},{"name":"receivePrevote","transitions":[{"target":"","guard":null,"actions":[{"type":"receivePrevote","params":[]}],"meta":[]}]},{"name":"start","transitions":[{"target":"#Tendermint-P2P-8.initialized.started.Validator","guard":null,"actions":[{"type":"connectPeers","params":[]},{"type":"connectRooms","params":[]},{"type":"registerValidatorWithNetwork","params":[]},{"type":"requestBlockSync","params":[]}],"meta":[]}]},{"name":"receiveCommit","transitions":[{"target":"","guard":null,"actions":[{"type":"receiveCommit","params":[]}],"meta":[]}]},{"name":"receiveUpdateNodeRequest","transitions":[{"target":"","guard":null,"actions":[{"type":"receiveUpdateNodeRequest","params":[]}],"meta":[]}]},{"name":"receiveStateSyncResponse","transitions":[{"target":"","guard":null,"actions":[{"type":"receiveStateSyncResponse","params":[]},{"type":"requestValidatorNodeInfoIfSynced","params":[]}],"meta":[]}]}],"entry":[],"exit":[],"initial":"active","states":[{"name":"active","after":[{"name":"timeoutPropose","transitions":[{"target":"#Tendermint-P2P-8.initialized.started.Validator.prevote","guard":null,"actions":[{"type":"sendPrevoteNil","params":[]}],"meta":[]}]}],"always":[{"name":"always","transitions":[{"target":"#Tendermint-P2P-8.initialized.started.Proposer","guard":{"type":"isNextProposer","params":[]},"actions":[],"meta":[]}]}],"on":[{"name":"receiveBlockProposal","transitions":[{"target":"#Tendermint-P2P-8.initialized.started.Validator.prevote","guard":{"type":"ifSenderIsProposer","params":[]},"actions":[{"type":"receiveBlockProposal","params":[]},{"type":"sendPrevote","params":[]},{"type":"cancelActiveIntervals","params":[{"key":"after","value":"timeoutPropose"}]}],"meta":[]},{"target":"#Tendermint-P2P-8.initialized.started.Validator.prevote","guard":{"type":"ifForceProposalReset","params":[]},"actions":[{"type":"receiveBlockProposal","params":[]},{"type":"resetPrevotes","params":[]},{"type":"setRoundProposer","params":[]},{"type":"sendPrevote","params":[]},{"type":"cancelActiveIntervals","params":[{"key":"after","value":"timeoutPropose"}]}],"meta":[]}]}],"entry":[{"type":"incrementCurrentTerm","params":[]},{"type":"setRoundProposer","params":[]},{"type":"resetPrevotes","params":[]},{"type":"resetPrecommits","params":[]}],"exit":[],"initial":"","states":[]},{"name":"prevote","after":[{"name":"timeoutPrevote","transitions":[{"target":"#Tendermint-P2P-8.initialized.started.Validator.precommit","guard":{"type":"ifPrevoteAnyThreshold","params":[]},"actions":[{"type":"sendPrecommitNil","params":[]}],"meta":[]},{"target":"#Tendermint-P2P-8.initialized.started.Validator.active","guard":null,"actions":[],"meta":[]}]}],"always":[{"name":"always","transitions":[{"target":"#Tendermint-P2P-8.initialized.started.Validator.precommit","actions":[{"type":"setLockedValue","params":[]},{"type":"setLockedRound","params":[]},{"type":"sendPrecommit","params":[]},{"type":"setValidValue","params":[]},{"type":"setValidRound","params":[]},{"type":"cancelActiveIntervals","params":[{"key":"after","value":"timeoutPrevote"}]}],"guard":{"type":"ifPrevoteAcceptThreshold","params":[]},"meta":[]}]}],"on":[{"name":"receivePrevote","transitions":[{"target":"#Tendermint-P2P-8.initialized.started.Validator.prevote","guard":null,"actions":[{"type":"receivePrevote","params":[]}],"meta":[]}]},{"name":"receiveBlockProposal","transitions":[{"target":"","guard":{"type":"ifSenderIsProposer","params":[]},"actions":[{"type":"receiveBlockProposal","params":[]}],"meta":[]},{"target":"#Tendermint-P2P-8.initialized.started.Validator.prevote","guard":{"type":"ifForceProposalReset","params":[]},"actions":[{"type":"receiveBlockProposal","params":[]},{"type":"resetPrevotes","params":[]},{"type":"setRoundProposer","params":[]},{"type":"sendPrevote","params":[]},{"type":"cancelActiveIntervals","params":[{"key":"after","value":"timeoutPrevote"}]}],"meta":[]}]}],"entry":[],"exit":[],"initial":"","states":[]},{"name":"precommit","after":[{"name":"timeoutPrecommit","transitions":[{"target":"#Tendermint-P2P-8.initialized.started.Validator.active","guard":null,"actions":[],"meta":[]}]}],"always":[{"name":"always","transitions":[{"target":"#Tendermint-P2P-8.initialized.started.Validator.commit","actions":[{"type":"commitBlock","params":[]},{"type":"sendCommit","params":[]},{"type":"resetLockedRound","params":[]},{"type":"resetValidValue","params":[]},{"type":"resetValidRound","params":[]},{"type":"cancelActiveIntervals","params":[{"key":"after","value":"timeoutPrecommit"}]},{"type":"resetLockedValue","params":[]}],"guard":{"type":"ifPrecommitAcceptThreshold","params":[]},"meta":[]}]}],"on":[{"name":"receivePrecommit","transitions":[{"target":"#Tendermint-P2P-8.initialized.started.Validator.precommit","guard":null,"actions":[{"type":"receivePrecommit","params":[]}],"meta":[]}]},{"name":"receivePrevote","transitions":[{"target":"","guard":null,"actions":[{"type":"receivePrevote","params":[]}],"meta":[]}]},{"name":"receiveBlockProposal","transitions":[{"target":"","guard":{"type":"ifSenderIsProposer","params":[]},"actions":[{"type":"receiveBlockProposal","params":[]}],"meta":[]},{"target":"#Tendermint-P2P-8.initialized.started.Validator.precommit","guard":{"type":"ifForceProposalReset","params":[]},"actions":[{"type":"receiveBlockProposal","params":[]},{"type":"resetPrevotes","params":[]},{"type":"setRoundProposer","params":[]},{"type":"sendPrevote","params":[]},{"type":"cancelActiveIntervals","params":[{"key":"after","value":"timeoutPrecommit"}]}],"meta":[]}]}],"entry":[],"exit":[],"initial":"","states":[]},{"name":"commit","after":[{"name":"roundTimeout","transitions":[{"target":"#Tendermint-P2P-8.initialized.started.Validator.active","guard":null,"actions":[],"meta":[]}]}],"always":[],"on":[{"name":"receivePrecommit","transitions":[{"target":"","guard":null,"actions":[{"type":"receivePrecommit","params":[]}],"meta":[]}]},{"name":"receiveBlockProposal","transitions":[{"target":"#Tendermint-P2P-8.initialized.started.Validator.prevote","guard":{"type":"ifNextBlockProposal","params":[]},"actions":[{"type":"incrementCurrentTerm","params":[]},{"type":"setRoundProposer","params":[]},{"type":"resetPrevotes","params":[]},{"type":"resetPrecommits","params":[]},{"type":"receiveBlockProposal","params":[]},{"type":"sendPrevote","params":[]},{"type":"cancelActiveIntervals","params":[{"key":"after","value":"roundTimeout"}]}],"meta":[]}]}],"entry":[],"exit":[],"initial":"","states":[]}]},{"name":"Proposer","after":[],"always":[],"on":[{"name":"start","transitions":[{"target":"#Tendermint-P2P-8.initialized.started.Validator","guard":null,"actions":[{"type":"connectPeers","params":[]},{"type":"connectRooms","params":[]},{"type":"registerValidatorWithNetwork","params":[]},{"type":"requestBlockSync","params":[]}],"meta":[]}]},{"name":"stop","transitions":[{"target":"#Tendermint-P2P-8.stopped","guard":null,"actions":[],"meta":[]}]},{"name":"receiveUpdateNodeRequest","transitions":[{"target":"","guard":null,"actions":[{"type":"receiveUpdateNodeRequest","params":[]}],"meta":[]}]}],"entry":[],"exit":[],"initial":"active","states":[{"name":"active","after":[],"always":[{"name":"always","transitions":[{"target":"#Tendermint-P2P-8.initialized.started.Validator.prevote","guard":null,"actions":[],"meta":[]}]}],"on":[],"entry":[{"type":"proposeBlock","params":[]},{"type":"sendBlockProposal","params":[]},{"type":"sendPrevote","params":[]}],"exit":[],"initial":"","states":[]}]}]}]},{"name":"stopped","after":[],"always":[],"on":[{"name":"restart","transitions":[{"target":"#Tendermint-P2P-8.initialized.unstarted","guard":null,"actions":[],"meta":[]}]}],"entry":[],"exit":[],"initial":"","states":[]}]}`
